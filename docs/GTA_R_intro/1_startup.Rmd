---
title: "R_startup.Rmd"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
    code_download: true
---

```{r knitr options, include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.asp = 0.618, fig.show = 'hold', eval = F, warning=T, comment=NA, prompt=FALSE, message = F, strip.white = F, class.source = "bc-b", attr.source='.numberLines', results = 'hold')
```



# The purpose of this course

- An introduction to basic techniques of data manipulation in R
- Focusing specifically on the basic procedures and methods that will be taught on the SOC2069 module to 2nd-year undergraduate students in Sociology

# What is R? What is RStudio?

The term "`R`" is used to refer to both the programming language and the software that interprets the scripts written using it.

[RStudio](https://rstudio.com) is currently a very popular way to not only write your R scripts but also to interact with the R software. To function correctly, RStudio needs R and therefore both need to be installed on your computer.

To make it easier to interact with R, we will use RStudio. RStudio is the most popular IDE (Integrated Development Environment) for R. An IDE is a piece of software that provides tools to make programming easier.

# Why learn R?

- R does not involve lots of pointing and clicking, and that's a good thing - it forces us to work with *scripts*, which makes the steps you used in your analysis clear, and the code you write can be inspected by someone else who can give you feedback and spot mistakes
- R code is great for reproducibility
- R is interdisciplinary and extensible
- R produces high-quality graphics
- R is free, open-source and cross-platform

# Getting R and RStudio

**R** and **RStudio** are separate downloads and installations. R is the
underlying statistical computing environment, but using R alone is no
fun. RStudio is a graphical integrated development environment (IDE) that makes
using R much easier and more interactive. You need to install R before you
install RStudio. Once installed, because RStudio is an IDE, RStudio will run R in 
the background.  You do not need to run it separately, but we'll check how it looks like just to get an idea.

## On Windows

* Download R from
  the [CRAN website](http://cran.r-project.org/bin/windows/base/release.htm).
* Run the `.exe` file that was just downloaded.
* Go to the [RStudio download page](https://www.rstudio.com/products/rstudio/download/#download).
* Under *Installers* select **RStudio x.yy.zzz - Windows.
  Vista/7/8/10** (where x, y, and z represent version numbers).
* Double click the file to install it.
* Once it's installed, open RStudio to make sure it works and you don't get any
  error messages.
  
## On Mac OS

* Download R from
  the [CRAN website](http://cran.r-project.org/bin/macosx/).
* Select the `.pkg` file for the latest R version.
* Double click on the downloaded file to install R.
* It is also a good idea to install [XQuartz](https://www.xquartz.org/) (needed
  by some packages).
* Go to the [RStudio download page](https://www.rstudio.com/products/rstudio/download/#download).
* Under *Installers* select **RStudio x.yy.zzz - Mac OS X 10.6+ (64-bit)**
  (where x, y, and z represent version numbers).
* Double click the file to install RStudio.
* Once it's installed, open RStudio to make sure it works and you don't get any
  error messages.
  
## Update R and RStudio:

If you already have R and RStudio installed and would like to update them to the newest version:

* Open RStudio, and click on "Help" > "Check for updates". If a new version is
	available, quit RStudio, and download the latest version for RStudio.
* To check which version of R you are using, start RStudio and the first thing
  that appears in the console indicates the version of R you are
  running. Alternatively, you can type `sessionInfo()`, which will also display
  which version of R you are running. Go on
  the [CRAN website](https://cran.r-project.org/) and check
  whether a more recent version is available. If so, you can update R using
  the `installr` package and the `updateR()` function:
  
```{r eval=FALSE, include=TRUE, eval=F}
installr::updateR()
```


# R and the RStudio interface

1. Once installed, let's have a look at how `R` looks like, just so we know
2. But we'll only be using `R` via `RStudio` in this course and in actual research, so let's explore `RStudio` a bit more. Let's open the `RStudio` programme that we have just installed.

# RStudio Panes

RStudio shows you four panes:

1. The 'Source' pane: the file where you write your code
2. The 'Console' where actual code is run
3. The 'Environment' pane, which shows you variables / datasets
3. The 'Viewer' pane, which shows you plots and help files

![](images/console_etc.png)

You can arrange these in any order using Tools > Global Options.

We can't actually see a *source script* in our new window yet, but we can open one or create a new one. For instance, we can open the source document for this `html` page, which is a so-called `Rmarkdown` file, a type of text file that combines written text and R code, together with outputs. This is the format that we'll ask students to use for Assignment 2, so we'll have a look a bit later. Or we can create a new R script to wich we can copy and store the commands we see below.

But first, let's find our way (i.e. working directory).

# Finding and setting the working directory

Setting a 'working directory' tells R where to look for and save files. First, with the `getwd()` function we can check which directory we are in at the moment. We can then set another directory

## Setting a directory manually (not really recommended...)

Within `RStudio go to Session >> Set Working Directory > Choose Directory...`

You also have an option to set the working directory to the most recently-loaded .R or .Rmd file.

Or you can use the function: `setwd("path/to/directory")`

Unfortunately, if you are on a Windows machine you will need to change all backslashes `\` to forward slashes `/`. This is because R follows UNIX conventions which are native to Linux and Mac computers.

Getting the right path is a vital first step in R, and you really need to know how to do this. Here are some instructional videos if you get stuck...

For Windows computers refer to [this YouTube video](https://www.youtube.com/watch?v=QzSV8wvA1Do). For Macs refer to [this YouTube video](https://www.youtube.com/watch?v=43W9TuPwqac).

However this is a big problem with this approach. If you send your file to someone else who is working on a different machine, it is most likely that your path will be pointing to the wrong location

## Setting a directory using an R project

By far the best way to set the working directory is to create and "R Project" in RStudio. When you do this, the RProject stores all files and data objects which were opened in the last session, and also keeps track of where the files are stored, so there is no need to set the directory.
Let's have a quick look how to do this:
1. Create a new folder set up as an R project
2. Download the `Rmd` file underpinning this page into that folder
3. Let's create a new R script in that folder.


# Using R as a calculator

We can use the console for general arithmetic

```{r}

1 + 3 + 5
(2 + 9) / 7

1 + 2+ 3

```

We can also create variables, e.g.

```{r}

x <- 10 # This is a comment
x = 10 # Does the same thing!!
y <- 21
x*y

```


# Comments

If you'd like to comment on any code you write (i.e. you do not wish R to try to 'run' this code) just add a hash (`#`) or series of hashes in front of it, e.g.

`df <- read.csv("csv_file.csv") # This reads in the main file for the experiment`


# Functions

Most work in R is done using _Functions_. These take the following form: _function(argument(s))_. Here are some functions

```{r}

sqrt(10)

seq(1, 10, 2)

rep(5, 10)

```

# Working with Functions

EX1: What do the arguments of `seq` and `rep` do? To find out more search for the relevant help file in the console by typing `?seq` or by using Google.

EX2: Have a look at the following arguments called `gsub` and `grepl`. What do they do? Clue: if you're stuck, search the help file using `?`

```{r}

gsub("R-studio", "Rstudio", "R-studio is a great piece of software")

grepl("chocolate", "Mary likes chocolate cookies")

```


# DIY functions

It's possible to **create your own functions**. This makes R extremely powerful and extendible. We're not going to cover making your own functions in this course, but it's important to be aware of this capability. There are plenty of good resources online for learning how to do this, including [this one](https://www.statmethods.net/management/userfunctions.html)

# Getting help

As we have seen above, to find out about a particular function just type `?` and the name of the function into the console, e.g. `?grepl`. This accesses the help files on your computer. If you'd like to search more broadly type `??grepl` and your computer will look online for relevant materials on CRAN (the main R website)

Help files in R are quite densely written and not particularly aimed at beginners. Fortunately there are loads of excellent resources on the internet. Here are some really good sites:

(a) [https://www.tidyverse.org/](https://www.tidyverse.org/) - A brilliant set of of resources on all things related to the tidyverse, Hadley Wickham's brilliant suite of packages
(b) [https://www.statmethods.net/index.html](https://www.statmethods.net/index.html) - a quick way of looking up basic R techniques
(c) [https://stats.idre.ucla.edu/r/modules/](https://stats.idre.ucla.edu/r/modules/)
(d) [https://rseek.org/](https://rseek.org/) - a search engine for all things related to R (because the word 'R' brings up a whole load of irrelevant stuff in Google)
(e) [http://www.cookbook-r.com/](http://www.cookbook-r.com/) - this has lots of tips on how to do graphics.



# Packages

Instead of programming your own functions in the ***R*** language, you can rely on functions written by other people and bundled within a package that performs some set task. There are a large number of reliable, tested and oft-used packages containing functions that are particularly useful for social scientists.  

Some particularly useful packages:
  - the ```tidyverse``` bundle of packages, which includes the ```dplyr``` package (for data manipulation) and additional R packages for reading in (`readr`), transforming (`tidyr`) and visualizing (`ggplot2`) datasets. It also ports the `%>%` so-called pipe operator that helps write more human-readable code
  - to import datasets in non-native formats and to manage attached labels (a concept familiar from other statistical packages but foreign to ***R***), load the `sjlabelled` package (an alternative to `haven` and `labelled`, which work in a similar way but provide less functionality) 
  - the `summarytools` package can be useful for making simple summary tables and crosstabulations
  - the `sjmisc` package contains very useful functions for undertaking data transformations on labelled variables (recoding, grouping, missing values, etc); also has some useful tabulation functions
  - the `sjPlot` package contains functions for graphing and tabulating results from regression models
  - the `mosaic` and `ggformula` packages provide functions to write data visualisation commands using "formula syntax", which is particularly useful for introductory-level teaching/learning as it unifies data description and statistical modelling around a shared logical structure (read about it [here](http://www.mosaic-web.org/ggformula/articles/pkgdown/ggformula-blog.html) and [here](http://www.mosaic-web.org/mosaic/articles/web-only/LessVolume-MoreCreativity.html))

Packages are often available from the *Comprehensive R Archive Network* (CRAN) or private repositories such as *Bioconductor*, *GitHub* etc. Packages made available on CRAN can be installed using the command `install.packages("packagename")`. Once the package/library is installed (i.e. it is sitting somewhere on your computer), we then need to _load_ it to the current R session using the command `library(packagename)`.

So using a package/library is a two-stage process. We:

1. `Install` the package/library onto your computer (from the internet)
2. `Load` the package/library into your current session using the library command.

Let's start by installing the 'tidyverse' package, and then load it:

```{r, eval=FALSE}
install.packages("tidyverse")  ## this command installs packages from CRAN; note the quotation marks around the package name
```

You can check the suite of packages that are loaded when you load the `Tidyverse` library using a comand from the `tidyverse` itself:

```{r, eval=FALSE}
tidyverse_packages()
```

<span style="color: red;">**QUESTION: Why do you think we gon an error message when we tried to run the above command?**</span>

Because `tidyverse_packages()` is itself a function from the `tidyverse`, in order to use that function we need not only to install the `tidyverse` but also to make its functions available. In other words, we did not yet *load* the `tidyverse` for use in our R session, we only just installed it on our computers.

If we don't want to load a package that we have downloaded - because maybe we only want to use a single function once and we don't want to burden our computer's memory, we can state explicitly which package the function is from in the following way:

```{r, eval=FALSE}
tidyverse::tidyverse_packages()        # Here we state the package followed by two colons, then followed by the function we want
```


But in many cases we do want to use several functions at various points in an analysis session, so it is usually useful to *load* the entire package or set of packages:

```{r, eval=FALSE}
library(tidyverse)             ## this command loads the packages in our session so we can use functions from it without having to refer to the package name first
```

Now we can use functions from that pakcage without having to explicitly state the name of the package. We can still state the name explicitly, and that may be useful for readers of our code to understand what package a function come from. Also, it may happen that different packages have similarly named functions, and if all those packages are loaded, then the functions from a package loaded later will override that in the package loaded earlier. `R` will note in a comment whether any functions from a package are **masked** by another, so it's worth paying attention to the comments and warnings printed by `R` when we load packages.

There are also convenience tools - e.g. the `pacman` package - that make it easier to load several packages at once, while at the same time downloading the package if it has not yet been downloaded on our computer.

For example, we can download a number of packages with the command below:

```{r}

# Install 'pacman' if not yet installed:

if (!require("pacman")) install.packages("pacman") 

# Then load/install other packages using 'pacman':

pacman::p_load(
  tidyverse,    # general data management tools ('dplyr', etc.)
  mosaic,       # formula-type syntax for descriptive statistics
  ggformula,    # ggplot2 powered graphing using 'mosaic' formula-syntax
  summarytools, # summary statistics tables
  sjlabelled,   # data import from other software (alternative to 'haven') and labels management
  sjmisc,       # data transformation on variables (recoding,grouping, missing values, etc)
  sjPlot,       # Graphing and tabulation tools for regression model results
  jtools       # Graphing and tabulation tools for regression model results
  )
```

# About the `Tidyverse`

## Data frames and 'tibbles'

The `Tidyverse` is built around the basic concept that data in a table should have one observation per row, one variable per column, and only one value per cell. Once data is in this 'tidy' format, it can be transformed, visualized and modelled for an analysis.

When using functions in the `Tidyverse` ecosystem, most data is returned as a `tibble` object. `Tibbles` are very similar to the `data.frames` (which are the basic types of object storing datasets in base ***R***) and it is perfectly fine to use `Tidyverse` functions on a `data.frame` object. Just be aware that in most cases, the `Tidyverse` function will transform your data into a `tibble.` If you are unobservant, you won't even notice a difference. However, there are a few differences between the two data types, most of which are just designed to make your life easier. For more info, check [R for Data Science](https://r4ds.had.co.nz/tibbles.html) and [R for Social Scientists](https://datacarpentry.org/r-socialsci/02-starting-with-data/index.html)

## Selected `dplyr` functions

The `dplyr` package is designed to make it easier to manipulate flat (2-D) data (i.e. the type of datasets we are most likely to use, which are laid out as in a standard spreadsheet, with rows referring to cases (observations; respondents) and columns referring to variables. `dplyr` provides simple "verbs", functions that correspond to the most common data manipulation tasks, to help you translate your thoughts into code. Here are some of the most common functions in `dplyr`:

  * `filter()` chooses rows based on column values.
  * `arrange()` changes the order of the rows.
  * `select()` changes whether or not a column is included.
  * `rename()` changes the name of columns.
  * `mutate()`/`transmute()` changes the values of columns and creates new columns (variables)
  * `summarise()` compute statistical summaries (e.g., computing the mean or the sum)
  * `group_by()` group data into rows with the same values
  * `ungroup()` remove grouping information from data frame.
  * `distinct()` remove duplicate rows. 

All these functions work similarly as follow:

- The first argument is a data frame/tibble 
- The subsequent arguments are comma separated list of unquoted variable names and the specification of what you want to do
- The result is a new data frame

For more info, check [R for Social Scientists](https://datacarpentry.org/r-socialsci/03-dplyr-tidyr/index.html)


## The forward-pipe (`%>%`) workflow

All of the `dplyr` functions take a data frame or tibble as the first argument. Rather than forcing the user to either save intermediate objects or nest functions, `dplyr` provides the forward-pipe operator `%>%` from the  `magrittr` package. This operator allows us to combine multiple operations into a single sequential chain of actions.

Let’s start with a hypothetical example. Say you would like to perform a sequence of operations on data frame `x` using hypothetical functions `f()`, `g()`, and `h()`:

1.  Take x *then*
2.  Use x as an input to a function f() *then*
3.  Use the output of f(x) as an input to a function g() *then*
4.  Use the output of g(f(x)) as an input to a function h()

One way to achieve this sequence of operations is by using nesting parentheses as follows:

```
h(g(f(x)))
```

This code isn’t so hard to read since we are applying only three functions: `f()`, then `g()`, then `h()` and each of the functions is short in its name. Further, each of these functions also only has one argument. However, you can imagine that this will get progressively harder to read as the number of functions applied in your sequence increases and the arguments in each function increase as well. This is where the pipe operator `%>%` comes in handy. `%>%` takes the output of one function and then “pipes” it to be the input of the next function. Furthermore, a helpful trick is to read `%>%` as “then” or “and then.” For example, you can obtain the same output as the hypothetical sequence of functions as follows:

```
x %>% 
  f() %>% 
  g() %>% 
  h()
```

You would read this sequence as:

1. Take x *then*
2. Use this output as the input to the next function f() *then*
3. Use this output as the input to the next function g() *then*
4. Use this output as the input to the next function h()

So while both approaches achieve the same goal, the latter is much more human-readable because you can clearly read the sequence of operations line-by-line. Instead of typing out the three strange characters of the operator, one can use the keyboard shortcut *Ctrl + Shift + M* (Windows) or *Cmd + Shift + M* (MacOS) to paste the operator.

Note that since `R 4.1.0` there is also a [native pipe operator](https://www.r-bloggers.com/2021/05/the-new-r-pipe/) in ***R*** (|>), and in RStudio one can set the shortcut to paste the new pipe operator instead.

The `magrittr` package provides some other piping functions too. One of the most useful ones is the so-called assignment pipe operator `%<>%` in which the object mentioned to its left serves both as the initial value and as target (read more [here](https://rdrr.io/cran/magrittr/man/compound.html)). It is a useful tool because often our aim with a piping sequence is to update/overwrite an original object with the result. In other words, our aim often is:

```
x <- x %>% 
        f() %>% 
        g() %>% 
        h()
```
 0. <span style="color: red;">Overwrite x with the output of the following commands:</span> 
<br>
 1. Take x *then*
 2. Use this output as the input to the next function f() *then*
 3. Use this output as the input to the next function g() *then*
 4. Use this output as the input to the next function h()

Using the assignment operator, we can save on typing by using:

```
x %<>% 
  f() %>% 
  g() %>% 
  h()
```

Note, however, that the assignment operator is not ported with the `tidyverse` packages, so if you want to use it, you will need to install/load the `magrittr` package separately. To avoid any confusion, we won't use the `%<>%` operator in this tutorial. Also, it is often safer not to overwrite an existing object (e.g. dataset), but to create a new one, then delete the ones you no longer need:

```
x2 <- x %>% 
        f() %>% 
        g() %>% 
        h()
```

# Let's practice some data management:

https://cgmoreh.github.io/SSC7001M/20-notes/Data-manipulation.html

